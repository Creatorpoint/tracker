<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prime Tracker Pro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:white;}
.header{
  background:#111827;
  padding:15px 20px;
  display:flex;
  justify-content:space-between;
}
.container{padding:20px;}
.card{
  background:#1e293b;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
}
input{width:100%;padding:10px;margin-bottom:10px;}
button{padding:10px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;}
.small{font-size:14px;color:#94a3b8;}
</style>
</head>
<body>

<div class="header">
<h2>Prime Tracker Admin</h2>
<div>Live: <span id="liveCount">0</span></div>
</div>

<div class="container">

<div id="loginBox" class="card">
<h3>Admin Login</h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>

<div id="dashboard" style="display:none;">

<div class="card">
<h3>Create Link</h3>
<input id="url" placeholder="Enter URL">
<button onclick="createLink()">Generate</button>
<div id="result"></div>
</div>

<div class="card">
<h3>Generated Links</h3>
<div id="linkHistory"></div>
</div>

<div class="card">
<h3>Total Clicks: <span id="totalClicks">0</span></h3>
<canvas id="dateChart"></canvas>
</div>

<div class="card">
<h3>Add New Admin</h3>
<input id="newAdminEmail" placeholder="New Admin Email">
<input id="newAdminPass" placeholder="Password">
<button onclick="addAdmin()">Create Admin</button>
</div>

<button onclick="logout()">Logout</button>

</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAk7OeIvh-D7NC_QKkQNMria4GxL5fT2ws",
  authDomain: "prime-f23e6.firebaseapp.com",
  databaseURL: "https://prime-f23e6-default-rtdb.firebaseio.com/",
  projectId: "prime-f23e6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

window.login=()=>{
  signInWithEmailAndPassword(auth,
    email.value,
    password.value
  ).catch(e=>alert(e.message));
}

window.logout=()=>signOut(auth);

window.addAdmin=()=>{
  createUserWithEmailAndPassword(auth,
    newAdminEmail.value,
    newAdminPass.value
  ).then(()=>alert("Admin Created"))
  .catch(e=>alert(e.message));
}

onAuthStateChanged(auth,user=>{
  if(user){
    loginBox.style.display="none";
    dashboard.style.display="block";
    loadLinks();
    loadStats();
  }else{
    loginBox.style.display="block";
    dashboard.style.display="none";
  }
});

function randomID(){
  return Math.random().toString(36).substring(2,8);
}

window.createLink=async()=>{
  const id=randomID();
  await set(ref(db,"links/"+id),{
    original:url.value,
    created:Date.now()
  });
  result.innerHTML=`https://creatorpoint.github.io/Prime_tracker/?id=${id}`;
  loadLinks();
}

function loadLinks(){
  onValue(ref(db,"links"),snap=>{
    linkHistory.innerHTML="";
    snap.forEach(l=>{
      const div=document.createElement("div");
      div.className="small";
      div.innerText=`${l.key}`;
      linkHistory.appendChild(div);
    });
  });
}

function loadStats(){
  onValue(ref(db,"clicks"),snap=>{
    let total=0;
    let dateData={};

    snap.forEach(link=>{
      link.forEach(click=>{
        total++;
        const d=click.val().date;
        dateData[d]=(dateData[d]||0)+1;
      });
    });

    totalClicks.innerText=total;
    renderChart(dateData);
  });
}

function renderChart(data){
  new Chart(dateChart,{
    type:"line",
    data:{
      labels:Object.keys(data),
      datasets:[{
        data:Object.values(data),
        borderColor:"#3b82f6"
      }]
    }
  });
}

onValue(ref(db,"liveUsers"),snap=>{
  liveCount.innerText=snap.exists()?snap.size:0;
});

</script>

</body>
</html>
